description: Perform a security scan using Aikido Security's CI API client

parameters:
  aikido_api_key:
    type: string
    default: $AIKIDO_API_KEY
    description: Key generated by Aikido Security. Can be generated at https://app.aikido.dev/settings/integrations/continuous-integration
  repository_id:
    type: string
    default: $AIKIDO_REPOSITORY_ID
    description: Repository id where the current pipeline is running
  base_commit_sha:
    type: string
    description: Commit sha where the current branch is based on
  head_commit_sha:
    type: string
    description: Commit sha of the current branch's head

docker:
  - image: cimg/node:16.20.2

steps:
  - run:
      name: Install Aikido Security CI API client
      command: <<include(scripts/install.sh)>>
  - run:
      name: Scan using Aikdo's Security CI API client for this commit
      environment:
        REPO_ID: <<parameters.repository_id>>
        BASE_COMMIT_SHA: <<parameters.base_commit_sha>>
        HEAD_COMMIT_SHA: <<parameters.head_commit_sha>>
        AIKIDO_API_KEY: <<parameters.aikido_api_key>>
      command: <<include(scripts/security_scan.sh)>>
