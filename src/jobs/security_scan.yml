description: |
  Perform a security scan using Aikido Security's CI API client.
  The environment variables AIKIDO_API_KEY & AIKIDO_REPOSITORY_ID must be set for this scan to work

parameters:
  base_branch:
    type: string
    default: main
    description: Commit sha where the current branch is based on
  head_commit_sha:
    type: string
    description: Commit sha of the current branch's head
  fail_on_dependency_scan:
    type: boolean
    default: true
    description: Flag used to make job fail when new issues are found during the dependency scan
  fail_on_sast_scan:
    type: boolean
    default: false
    description: Flag used to make job fail when new issues are found during the sast scan
  fail_on_iac_scan:
    type: boolean
    default: false
    description: Flag used to make job fail when new issues are found during the infrastructure as code scan
  minimum_severity:
    type: enum
    default: CRITICAL
    enum: [LOW, MEDIUM, HIGH, CRITICAL]
    description: Severity used to make job fail when new issues are found with this severity or higher

docker:
  - image: cimg/node:16.20.2

steps:
  - checkout
  - run:
      name: Install Aikido Security CI API client
      command: <<include(scripts/install.sh)>>
  - run:
      name: Scan using Aikdo's Security CI API client for this commit
      environment:
        BASE_BRANCH: <<parameters.base_branch>>
        HEAD_COMMIT_SHA: <<parameters.head_commit_sha>>
        FAIL_ON_DEPENDENCY_SCAN: <<parameters.fail_on_dependency_scan>>
        FAIL_ON_SAST_SCAN: <<parameters.fail_on_sast_scan>>
        FAIL_ON_IAC_SCAN: <<parameters.fail_on_iac_scan>>
        MINIMUM_SEVERITY: <<parameters.minimum_severity>>
      command: <<include(scripts/security_scan.sh)>>
